# VRF Solidity æµ‹è¯•è¯´æ˜

## ğŸ“¦ å·²åˆ›å»ºçš„æ–‡ä»¶

æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶å’Œæ–‡æ¡£ï¼š

### æµ‹è¯•æ–‡ä»¶
1. **`test/test_vrf_simple.js`** - ç®€å•æµ‹è¯•ï¼ˆæ¨èæ–°æ‰‹ï¼‰
   - ä½¿ç”¨é¢„å®šä¹‰æµ‹è¯•å‘é‡
   - ä¸ä¾èµ–å¤–éƒ¨ç¨‹åº
   - å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½

2. **`test/test_vrf_with_c_generator.js`** - C é›†æˆæµ‹è¯•ï¼ˆé«˜çº§ï¼‰
   - é›†æˆä½ çš„ C ç¨‹åº
   - è·¨å¹³å°éªŒè¯
   - å®æ—¶ç”Ÿæˆå’ŒéªŒè¯

### æ–‡æ¡£æ–‡ä»¶
1. **`QUICK_START.md`** - å¿«é€Ÿå¼€å§‹æŒ‡å—ï¼ˆ3 æ­¥ä¸Šæ‰‹ï¼‰
2. **`TEST_GUIDE.md`** - è¯¦ç»†æµ‹è¯•æŒ‡å—ï¼ˆå®Œæ•´æ–‡æ¡£ï¼‰
3. **`run_tests.sh`** - ä¾¿æ·è¿è¡Œè„šæœ¬ï¼ˆå·²æ·»åŠ æ‰§è¡Œæƒé™ï¼‰

---

## ğŸš€ ç«‹å³å¼€å§‹æµ‹è¯•

### æ–¹æ³• 1ï¼šä½¿ç”¨ä¾¿æ·è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/zxx/Config/vrf-solidity-master

# é¦–æ¬¡è¿è¡Œï¼šåˆå§‹åŒ–é¡¹ç›®ï¼ˆå®‰è£…ä¾èµ– + ç¼–è¯‘åˆçº¦ï¼‰
./run_tests.sh setup

# è¿è¡Œç®€å•æµ‹è¯•
./run_tests.sh simple

# æŸ¥çœ‹æ‰€æœ‰é€‰é¡¹
./run_tests.sh help
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ Truffle å‘½ä»¤

```bash
cd /home/zxx/Config/vrf-solidity-master

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install

# ç¼–è¯‘åˆçº¦
truffle compile

# è¿è¡Œç®€å•æµ‹è¯•
truffle test test/test_vrf_simple.js

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
truffle test
```

---

## ğŸ“‹ æµ‹è¯•å†…å®¹æ¦‚è§ˆ

### `test_vrf_simple.js` åŒ…å«çš„æµ‹è¯•ï¼š

âœ… **æµ‹è¯• 1ï¼šéªŒè¯æœ‰æ•ˆçš„ VRF è¯æ˜**
- è§£ç å…¬é’¥å’Œè¯æ˜
- æ‰§è¡Œ VRF éªŒè¯
- æå–éšæœºæ•°å“ˆå¸Œ

âœ… **æµ‹è¯• 2ï¼šéªŒè¯å¤šä¸ªä¸åŒçš„æœ‰æ•ˆè¯æ˜**
- æµ‹è¯• 3 ä¸ªä¸åŒçš„æµ‹è¯•å‘é‡
- éªŒè¯æ¯ä¸ªéƒ½èƒ½æˆåŠŸ
- ç¡®è®¤éšæœºæ•°å”¯ä¸€æ€§

âœ… **æµ‹è¯• 3ï¼šæ‹’ç»æ— æ•ˆçš„è¯æ˜**
- ä½¿ç”¨é”™è¯¯çš„æ¶ˆæ¯
- éªŒè¯åº”è¯¥å¤±è´¥

âœ… **æµ‹è¯• 4ï¼šç¡®å®šæ€§éšæœºæ•°ç”Ÿæˆ**
- ç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒè¾“å‡º

âœ… **æµ‹è¯• 5ï¼šä¸åŒè¾“å…¥äº§ç”Ÿä¸åŒéšæœºæ•°**
- éªŒè¯éšæœºæ€§

âœ… **æµ‹è¯• 6ï¼šGas æ¶ˆè€—åˆ†æ**
- æ˜¾ç¤ºå‚è€ƒ Gas æ¶ˆè€—

### `test_vrf_with_c_generator.js` åŒ…å«çš„æµ‹è¯•ï¼š

âœ… **æµ‹è¯• 1ï¼šC ç”Ÿæˆ + Solidity éªŒè¯**
- è°ƒç”¨ C ç¨‹åºç”Ÿæˆ VRF
- åœ¨åˆçº¦ä¸­éªŒè¯
- å¯¹æ¯”éšæœºæ•°

âœ… **æµ‹è¯• 2ï¼šå¤šæ¶ˆæ¯éªŒè¯**
- ç”Ÿæˆå¤šä¸ªä¸åŒçš„ VRF
- éªŒè¯å”¯ä¸€æ€§

âœ… **æµ‹è¯• 3ï¼šç¡®å®šæ€§éªŒè¯**
- éªŒè¯ VRF çš„ç¡®å®šæ€§ç‰¹æ€§

âœ… **æµ‹è¯• 4ï¼šé¢„å®šä¹‰æµ‹è¯•å‘é‡ï¼ˆå¤‡ç”¨ï¼‰**
- ä¸ä¾èµ– C ç¨‹åºçš„å¤‡ç”¨æµ‹è¯•

---

## ğŸ“Š é¢„æœŸè¾“å‡ºç¤ºä¾‹

è¿è¡Œ `./run_tests.sh simple` åï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
========================================
   VRF éªŒè¯æµ‹è¯• - ä½¿ç”¨ verify()
========================================

âœ… TestHelperVRF åˆçº¦å·²éƒ¨ç½²: 0x1234...

Contract: VRF Simple Test
  åŸºç¡€ VRF éªŒè¯æµ‹è¯•

    --- æµ‹è¯• 1: éªŒè¯æœ‰æ•ˆçš„ VRF è¯æ˜ ---
    è¾“å…¥æ•°æ®:
      å…¬é’¥: 0x03e30118c907034baf1456063bf7b423...
      è¯æ˜: 0x03e30118c907034baf1456063bf7b423...
      æ¶ˆæ¯: 0x73616d706c65

    æ­¥éª¤ 1: è§£ç å…¬é’¥
      å…¬é’¥ X: e30118c907034baf1456063bf7b42397...
      å…¬é’¥ Y: 52229bb0b81d4955bff53d8315c24a03...

    æ­¥éª¤ 2: è§£ç è¯æ˜
      Gamma X: e30118c907034baf1456063bf7b42397...
      Gamma Y: 52229bb0b81d4955bff53d8315c24a03...
      c: ed294d880a72183e25a6c5cf22f374e9
      s: f981e29d2334fa32d87dab2dfa7dc5a5...

    æ­¥éª¤ 3: å‡†å¤‡æ¶ˆæ¯
      æ¶ˆæ¯é•¿åº¦: 6 å­—èŠ‚

    æ­¥éª¤ 4: æ‰§è¡Œ VRF éªŒè¯...

    éªŒè¯ç»“æœ:
      éªŒè¯é€šè¿‡: true
      è€—æ—¶: 124 ms

    æ­¥éª¤ 5: æå–éšæœºæ•°
      éšæœºæ•°å“ˆå¸Œ: 0xafe6b3c31e87ec45dfd87b3cc5e60a73...
      æœŸæœ›çš„å“ˆå¸Œ: 0xafe6b3c31e87ec45dfd87b3cc5e60a73...

    âœ… æµ‹è¯• 1 å®Œæˆï¼šéªŒè¯æˆåŠŸï¼
    âœ“ åº”è¯¥æˆåŠŸéªŒè¯æœ‰æ•ˆçš„ VRF è¯æ˜ (2156ms)

    --- æµ‹è¯• 2: éªŒè¯å¤šä¸ªæœ‰æ•ˆè¯æ˜ ---
    æµ‹è¯•å‘é‡ 1:
      å…¬é’¥: 0x031f4dbca087a1972d04a07a779b7df1...
      âœ… éªŒè¯æˆåŠŸ

    æµ‹è¯•å‘é‡ 2:
      å…¬é’¥: 0x02ed1bb54a9092c8fd50ae8cea3322e1...
      âœ… éªŒè¯æˆåŠŸ

    æµ‹è¯•å‘é‡ 3:
      å…¬é’¥: 0x03359425334b14173856433b4e695f1d...
      âœ… éªŒè¯æˆåŠŸ

    âœ… æµ‹è¯• 2 å®Œæˆï¼š3/3 ä¸ªè¯æ˜éªŒè¯æˆåŠŸï¼
    âœ“ åº”è¯¥æˆåŠŸéªŒè¯å¤šä¸ªä¸åŒçš„æœ‰æ•ˆ VRF è¯æ˜ (3421ms)

  VRF éšæœºæ•°ç”Ÿæˆæµ‹è¯•
    âœ“ ç›¸åŒçš„è¾“å…¥åº”è¯¥äº§ç”Ÿç›¸åŒçš„éšæœºæ•° (89ms)
    âœ“ ä¸åŒçš„è¯æ˜åº”è¯¥äº§ç”Ÿä¸åŒçš„éšæœºæ•° (91ms)

  Gas æ¶ˆè€—åˆ†æ
    âœ“ åº”è¯¥æµ‹é‡ verify() å‡½æ•°çš„ Gas æ¶ˆè€— (12ms)

  6 passing (12s)

========================================
          æµ‹è¯•æ€»ç»“
========================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼

ä¸»è¦åŠŸèƒ½éªŒè¯ï¼š
  1. âœ… æˆåŠŸéªŒè¯æœ‰æ•ˆçš„ VRF è¯æ˜
  2. âœ… æˆåŠŸéªŒè¯å¤šä¸ªä¸åŒçš„è¯æ˜
  3. âœ… æ­£ç¡®æ‹’ç»æ— æ•ˆçš„è¯æ˜
  4. âœ… ç¡®å®šæ€§éšæœºæ•°ç”Ÿæˆ
  5. âœ… ä¸åŒè¾“å…¥äº§ç”Ÿä¸åŒéšæœºæ•°
  6. âœ… Gas æ¶ˆè€—ä¿¡æ¯

å»ºè®®ï¼š
  â€¢ ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ fastVerify() èŠ‚çœ Gas
  â€¢ åœ¨é“¾å¤–è®¡ç®— computeFastVerifyParams()
  â€¢ éšæœºæ•°å…·æœ‰ç¡®å®šæ€§å’Œä¸å¯é¢„æµ‹æ€§
========================================
```

---

## ğŸ¯ å…³é”®åŠŸèƒ½è¯´æ˜

### VRF éªŒè¯æµç¨‹

```
è¾“å…¥ â†’ è§£ç  â†’ éªŒè¯ â†’ è¾“å‡ºéšæœºæ•°
  â†“      â†“      â†“         â†“
å…¬é’¥   [x,y]  verify()  bytes32
è¯æ˜   [Î³x,Î³y,c,s]  âœ“    hash
æ¶ˆæ¯   bytes
```

### ä¸»è¦å‡½æ•°

1. **`decodePoint(bytes)`** - è§£ç å‹ç¼©å…¬é’¥ï¼ˆ33 å­—èŠ‚ â†’ [x, y]ï¼‰
2. **`decodeProof(bytes)`** - è§£ç è¯æ˜ï¼ˆ81 å­—èŠ‚ â†’ [Î³x, Î³y, c, s]ï¼‰
3. **`verify(publicKey, proof, message)`** - éªŒè¯ VRF è¯æ˜
4. **`gammaToHash(Î³x, Î³y)`** - ç”Ÿæˆéšæœºæ•°å“ˆå¸Œ

### Gas æ¶ˆè€—å¯¹æ¯”

| å‡½æ•° | Gas | è¯´æ˜ |
|------|-----|------|
| `verify()` | ~1,643,712 | å®Œæ•´éªŒè¯ |
| `fastVerify()` | ~150,715 | å¿«é€ŸéªŒè¯ï¼ˆæ¨èï¼‰ |
| èŠ‚çœ | **91%** | ä½¿ç”¨ fastVerify |

---

## ğŸ” æµ‹è¯•æŠ€å·§

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# åªè¿è¡ŒæŸä¸ªæµ‹è¯•
truffle test test/test_vrf_simple.js --grep "åº”è¯¥æˆåŠŸéªŒè¯æœ‰æ•ˆ"

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
truffle test --show-events

# æŸ¥çœ‹å †æ ˆè·Ÿè¸ª
truffle test --stacktrace
```

### äº¤äº’å¼è°ƒè¯•

```bash
truffle console

> const helper = await TestHelperVRF.deployed()
> const proof = await helper.decodeProof.call("0x03...")
> console.log(proof)
```

---

## â“ å¸¸è§é—®é¢˜è§£ç­”

### Q1: å¦‚ä½•è¿è¡Œæœ€å¿«çš„æµ‹è¯•ï¼Ÿ
```bash
./run_tests.sh simple
```

### Q2: å¦‚ä½•é›†æˆ C ç¨‹åºï¼Ÿ
ç¡®ä¿ C ç¨‹åºåœ¨æ­£ç¡®è·¯å¾„ï¼š`/home/zxx/A2L/A2L-master/ecdsa/bin/vrf_test`
```bash
./run_tests.sh c-gen
```

### Q3: å¦‚ä½•æµ‹é‡ Gas æ¶ˆè€—ï¼Ÿ
```bash
./run_tests.sh gas
```

### Q4: ä¾èµ–å®‰è£…å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
```bash
./run_tests.sh clean   # æ¸…ç†å¹¶é‡è£…
```

### Q5: åˆçº¦ç¼–è¯‘å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
```bash
./run_tests.sh compile
```

---

## ğŸ“š å­¦ä¹ èµ„æº

- **å¿«é€Ÿå¼€å§‹ï¼š** æŸ¥çœ‹ `QUICK_START.md`
- **è¯¦ç»†æŒ‡å—ï¼š** æŸ¥çœ‹ `TEST_GUIDE.md`
- **ä»£ç ç¤ºä¾‹ï¼š** æŸ¥çœ‹ `test/test_vrf_simple.js`
- **VRF æ ‡å‡†ï¼š** [VRF-draft-04](https://tools.ietf.org/pdf/draft-irtf-cfrg-vrf-04)

---

## ğŸ‰ ä¸‹ä¸€æ­¥

1. **è¿è¡Œæµ‹è¯•**
   ```bash
   ./run_tests.sh simple
   ```

2. **æŸ¥çœ‹ä»£ç **
   ```bash
   cat test/test_vrf_simple.js
   ```

3. **ä¿®æ”¹æµ‹è¯•**
   - æ·»åŠ è‡ªå·±çš„æµ‹è¯•ç”¨ä¾‹
   - æµ‹è¯•ä¸åŒçš„æ¶ˆæ¯
   - éªŒè¯è‡ªå®šä¹‰åœºæ™¯

4. **é›†æˆåˆ°é¡¹ç›®**
   - å¤åˆ¶ `contracts/VRF.sol` åˆ°ä½ çš„é¡¹ç›®
   - å‚è€ƒæµ‹è¯•ä»£ç é›†æˆ
   - ä½¿ç”¨ `fastVerify()` ä¼˜åŒ– Gas

---

## ğŸ’¡ å°è´´å£«

- âœ… å§‹ç»ˆå…ˆè¿è¡Œ `./run_tests.sh setup` åˆå§‹åŒ–
- âœ… ä½¿ç”¨ `simple` æµ‹è¯•å¿«é€ŸéªŒè¯åŠŸèƒ½
- âœ… ä½¿ç”¨ `c-gen` æµ‹è¯•è·¨å¹³å°å…¼å®¹æ€§
- âœ… ä½¿ç”¨ `gas` åˆ†æä¼˜åŒ–æ€§èƒ½
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `fastVerify()` èŠ‚çœ Gas

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹æµ‹è¯•å§ï¼** ğŸš€

```bash
cd /home/zxx/Config/vrf-solidity-master
./run_tests.sh setup
./run_tests.sh simple
```

















