# update_and_rotate_new.js 脚本作用详解

## 📋 脚本概述

`update_and_rotate_new.js` 是一个**委员会轮换自动化脚本**，用于执行完整的委员会轮换流程。它将声誉更新、VRF生成验证和委员会轮换三个步骤整合在一起，实现自动化的委员会管理。

## 🎯 主要功能

### 一、基于真实决策数据更新声誉（第一部分）

#### 步骤1：计算统计数据
```javascript
// 执行 calculate_reputation_stats.sh
// 从 reputation_decisions.csv 读取决策记录
// 计算每个委员会成员的准确率和一致性
// 保存到 reputation_stats.csv
```

**作用**：
- 读取 `reputation_decisions.csv` 中的所有决策记录
- 对每个委员会成员地址计算：
  - **准确率**：决策正确的比例
  - **一致性**：与其他成员决策一致的比例
- 生成 `reputation_stats.csv` 统计数据文件

#### 步骤2：更新声誉到区块链
```javascript
// 执行 update_reputation_from_decisions.js
// 读取 reputation_stats.csv
// 调用 ReputationManager.updateReputation() 更新到区块链
```

**作用**：
- 读取 `reputation_stats.csv` 中的统计数据
- 对每个委员会成员调用 `ReputationManager.updateReputation(accuracy, participation, consistency)`
- 将准确率和一致性更新到区块链合约中

**数据流**：
```
reputation_decisions.csv (原始决策记录)
  ↓
calculate_reputation_stats.sh (计算统计数据)
  ↓
reputation_stats.csv (统计数据)
  ↓
update_reputation_from_decisions.js (更新到区块链)
  ↓
ReputationManager合约 (存储声誉值)
```

### 二、VRF 生成和验证（第二部分）

#### 步骤1：使用 C 程序生成 VRF
```javascript
// 调用 /home/zxx/A2L/A2L-master/ecdsa/bin/vrf_test
// 生成 VRF 随机数、证明和公钥
```

**作用**：
- 使用 C 程序 `vrf_test` 生成 VRF（可验证随机函数）数据
- 生成内容：
  - **公钥**：VRF 公钥（序列化格式）
  - **证明**：VRF 证明（用于验证随机数的有效性）
  - **随机数**：32字节的随机数（用于委员会选择）

#### 步骤2：转换数据格式
```javascript
// 将 C 程序输出的十六进制字符串转换为合约所需的格式
// 公钥、证明、消息都转换为字节数组
```

#### 步骤3：解码公钥和证明
```javascript
// 使用 VRFTestHelper.decodePoint() 解码公钥
// 使用 VRFTestHelper.decodeProof() 解码证明
```

#### 步骤4：在合约中验证
```javascript
// 调用 VRFTestHelper.verify() 验证 VRF 证明
// 确保随机数是可验证的、不可预测的
```

**作用**：
- 验证 C 程序生成的 VRF 证明在合约中是否有效
- 确保随机数的生成过程是可信的、不可被操纵的

#### 步骤5：提取随机数并对比
```javascript
// 从合约中提取随机数（gammaToHash）
// 与 C 程序生成的随机数对比
// 确保两者一致
```

**作用**：
- 验证合约和 C 程序生成的随机数是否一致
- 确保 VRF 实现的一致性

### 三、委员会轮换（第三部分）

#### 步骤1：检查是否可以轮换
```javascript
// 调用 CommitteeRotation.canRotate()
// 检查时间间隔是否满足（ROTATION_INTERVAL = 20秒）
```

**条件**：
- 上次轮换后至少 20 秒
- 候选池大小 >= 3（MAX_COMMITTEE_SIZE）
- VRF 随机数已设置且未使用

#### 步骤2：提交 VRF 随机数到合约
```javascript
// 调用 CommitteeRotation.submitVRFRandomWithProof()
// 提交新生成的 VRF 随机数、证明、公钥和消息
```

**作用**：
- 将第二部分生成的 VRF 数据提交到 `CommitteeRotation` 合约
- 替换合约中的旧 VRF 随机数

#### 步骤3：验证 VRF 证明
```javascript
// 调用 CommitteeRotation.verifyVRFProof()
// 验证提交的 VRF 证明是否有效
```

**作用**：
- 在合约中验证 VRF 证明的有效性
- 确保随机数生成过程是可信的

#### 步骤4：执行委员会轮换
```javascript
// 调用 CommitteeRotation.rotateCommittee()
// 使用加权轮盘赌算法选择新委员会
```

**轮换算法**：
1. **收集候选者声誉**：从 `ReputationManager` 读取所有候选者的综合声誉
2. **选择 Top-K**：选择声誉最高的前 10 名候选者
3. **计算权重**：根据声誉值计算权重（高分候选者权重更高）
4. **加权轮盘赌选择**：使用 VRF 随机数进行加权选择（无放回）
5. **更新委员会**：将选中的 3 个成员设置为新委员会

#### 步骤5：更新委员会文件
```javascript
// 将新委员会成员地址写入 committee_members.txt
// 使用原子写入（先写临时文件，再重命名）避免读取冲突
```

**作用**：
- 将新委员会成员地址保存到 `committee_members.txt`
- 供 `secret_share_receiver` 等程序读取当前委员会成员

## 📊 完整执行流程

```
┌─────────────────────────────────────┐
│  第一部分：更新声誉                  │
│  ┌───────────────────────────────┐ │
│  │ 1. calculate_reputation_stats │ │
│  │    (计算统计数据)              │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 2. update_reputation_from_   │ │
│  │    decisions.js               │ │
│  │    (更新到区块链)              │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  第二部分：VRF 生成和验证            │
│  ┌───────────────────────────────┐ │
│  │ 1. C程序生成VRF               │ │
│  │    (随机数、证明、公钥)        │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 2. 转换数据格式                │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 3. 解码公钥和证明              │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 4. 合约验证VRF证明             │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 5. 提取并对比随机数            │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  第三部分：委员会轮换                │
│  ┌───────────────────────────────┐ │
│  │ 1. 检查是否可以轮换             │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 2. 提交VRF到合约               │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 3. 验证VRF证明                 │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 4. 执行轮换                    │ │
│  │    (加权轮盘赌选择)             │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 5. 更新committee_members.txt   │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 🔧 配置参数

### 文件路径
- `VRF_TEST_PATH`: `/home/zxx/A2L/A2L-master/ecdsa/bin/vrf_test` - VRF生成程序
- `VRF_KEY_FILE`: `/home/zxx/A2L/A2L-master/ecdsa/tumbler_vrf_key.bin` - VRF密钥文件
- `COMMITTEE_MEMBERS_FILE`: `/home/zxx/A2L/A2L-master/ecdsa/committee_members.txt` - 委员会成员文件

### 合约地址
- `VRF_TEST_HELPER_ADDRESS`: `0xCD4FB6a48bEB62dd3caD96e3b257bb1e4E3D4703` - VRF测试辅助合约
- `COMMITTEE_ROTATION_ADDRESS`: `0x7422B6F8bd5b4d72e3071e6E3166a223a0000f02` - 委员会轮换合约
- `REPUTATION_MANAGER_ADDRESS`: `0xEb892af82bE8F7a1434da362c9434129Fa80FA9B` - 声誉管理合约

## 🚀 运行方式

```bash
# 在 truffle 项目目录下运行
cd /home/zxx/Config/truffleProject/truffletest
truffle exec scripts/update_and_rotate_new.js --network private
```

**注意**：
- 脚本中第240行使用的是 `--network development`，但根据注释应该使用 `--network private`
- 需要确保合约已部署到指定网络
- 需要确保 C 程序 `vrf_test` 存在且可执行

## ⚠️ 关键点

### 1. 网络配置
脚本中第240行调用 `update_reputation_from_decisions.js` 时使用的是 `--network development`，但根据合约地址注释，应该使用 `--network private`。这可能导致声誉更新失败。

### 2. 错误处理
- 第一部分（声誉更新）失败时，脚本会继续执行后续步骤（不抛出错误）
- 第二部分（VRF验证）失败时，会抛出错误并停止执行
- 第三部分（轮换）失败时，会记录错误但不会影响脚本完成

### 3. 原子写入
更新 `committee_members.txt` 时使用原子写入方式：
1. 先写入临时文件 `committee_members.txt.tmp`
2. 再重命名为 `committee_members.txt`
3. 避免读取时文件不完整的问题

### 4. 时间控制
轮换有最小时间间隔（20秒），如果时间未到，脚本会显示等待时间，但不会执行轮换。

## 📝 输出示例

```
========================================
   委员会轮换 - 声誉更新 + VRF 验证 + 轮换
========================================

✅ VRFTestHelper 合约: 0xCD4FB6a48bEB62dd3caD96e3b257bb1e4E3D4703
✅ CommitteeRotation 合约: 0x7422B6F8bd5b4d72e3071e6E3166a223a0000f02
✅ ReputationManager 合约: 0xEb892af82bE8F7a1434da362c9434129Fa80FA9B

========================================
   第一部分：基于真实决策数据更新声誉
========================================

当前委员会成员:
  1. 0x9483bA82278fD651ED64D5B2CC2d4d2BBFa94025 - 声誉: 165
  2. 0x9339c1E45F56ecF3af4EE2D976f31a12086Ad506 - 声誉: 180
  3. 0x27766bFd44aFDc46584E0550765181422c3BA080 - 声誉: 185

候选池大小: 10

--- 步骤1: 计算统计数据 ---
[REPUTATION] 地址 0x9483...: 准确率=75%, 一致性=90%, 综合声誉=165
✅ 统计数据计算完成

--- 步骤2: 更新声誉到区块链 ---
✅ 声誉更新完成

========================================
   第二部分：VRF 生成和验证
========================================

--- 从 C 程序生成 VRF ---
✅ C 端生成成功
  公钥: a1b2c3d4...
  证明长度: 128 字节
  随机数: 1a2b3c4d...

--- 步骤 4: 合约验证 ---
  验证结果: ✅ 成功
  耗时: 1234 ms

✅ VRF 验证完成：C 生成的证明在合约中验证成功！

========================================
   第三部分：委员会轮换
========================================

是否可以进行轮换: ✅ 是

📤 提交第二部分生成的新 VRF 到 CommitteeRotation 合约...
  ✅ VRF 提交成功，交易哈希: 0x1234...

🔍 验证 VRF 证明...
  ✅ VRF 验证成功

🔄 执行委员会轮换...
  ✅ 轮换成功，交易哈希: 0x5678...

新委员会成员:
  1. 0x9339c1E45F56ecF3af4EE2D976f31a12086Ad506 - 声誉: 180
  2. 0x27766bFd44aFDc46584E0550765181422c3BA080 - 声誉: 185
  3. 0x0048b8b3e353981a2b38c713c912c1267c374a73 - 声誉: 175

✅ 已写入新委员会成员到文件
文件路径: /home/zxx/A2L/A2L-master/ecdsa/committee_members.txt
```

## 🎯 总结

`update_and_rotate_new.js` 是一个**完整的委员会轮换自动化脚本**，它：

1. ✅ **更新声誉**：基于真实决策数据计算并更新委员会成员的声誉值
2. ✅ **生成VRF**：使用 C 程序生成可验证的随机数
3. ✅ **验证VRF**：在合约中验证随机数的有效性
4. ✅ **执行轮换**：使用加权轮盘赌算法选择新委员会
5. ✅ **更新文件**：将新委员会成员保存到文件

这个脚本是整个委员会轮换系统的核心，通常由 `auto_rotation_simple.sh` 定期调用执行。


